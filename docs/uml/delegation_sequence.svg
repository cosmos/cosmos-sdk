<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1931px" preserveAspectRatio="none" style="width:1913px;height:1931px;" version="1.1" viewBox="0 0 1913 1931" width="1913px" zoomAndPan="magnify"><defs><filter height="300%" id="f1hmxn5m89r15d" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="457" x="726.25" y="28.708">Delegating (currently undelegated funds delegator)</text><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="706.5" x="30" y="148.3828"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="158.3359" style="stroke:#000000;stroke-width:2.0;" width="842" x="83" y="208.6484"/><rect fill="#FFFFFF" height="56.9375" style="stroke:none;stroke-width:1.0;" width="842" x="83" y="310.0469"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="883.8672" style="stroke:#000000;stroke-width:2.0;" width="1334" x="565.5" y="380.9844"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="454.5313" style="stroke:#000000;stroke-width:2.0;" width="845" x="1044.5" y="434.25"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="339.1328" style="stroke:#000000;stroke-width:2.0;" width="825" x="1054.5" y="542.6484"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="90.2031" style="stroke:#000000;stroke-width:2.0;" width="795" x="1074.5" y="651.0469"/><rect fill="#FFFFFF" height="43.9375" style="stroke:none;stroke-width:1.0;" width="795" x="1074.5" y="697.3125"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="119.5313" style="stroke:#000000;stroke-width:2.0;" width="612" x="1064.5" y="755.25"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="592" x="1074.5" y="821.5156"/><rect fill="#FFFFFF" height="339.9375" style="stroke:none;stroke-width:1.0;" width="1334" x="565.5" y="924.9141"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="90.2031" style="stroke:#000000;stroke-width:2.0;" width="664" x="585.5" y="946.7188"/><rect fill="#FFFFFF" height="43.9375" style="stroke:none;stroke-width:1.0;" width="664" x="585.5" y="992.9844"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="206.9297" style="stroke:#000000;stroke-width:2.0;" width="1294" x="575.5" y="1050.9219"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="664" x="585.5" y="1146.3203"/><rect fill="#FFFFFF" filter="url(#f1hmxn5m89r15d)" height="71.3984" style="stroke:#000000;stroke-width:2.0;" width="1639.5" x="230" y="1519.9141"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="118" x2="118" y1="102.25" y2="1863.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="660.5" x2="660.5" y1="102.25" y2="1863.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="919.5" x2="919.5" y1="102.25" y2="1863.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1161.5" x2="1161.5" y1="102.25" y2="1863.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1593.5" x2="1593.5" y1="102.25" y2="1863.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1736.5" x2="1736.5" y1="102.25" y2="1863.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1838.5" x2="1838.5" y1="102.25" y2="1863.5078"/><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="152" x="40" y="66.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="47" y="86.9482">msgServer (staking)</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="152" x="40" y="1862.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="47" y="1882.5029">msgServer (staking)</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="127" x="595.5" y="66.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="602.5" y="86.9482">keeper (staking)</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="127" x="595.5" y="1862.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="602.5" y="1882.5029">keeper (staking)</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="71" x="882.5" y="66.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="889.5" y="86.9482">validator</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="71" x="882.5" y="1862.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="889.5" y="1882.5029">validator</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="151" x="1084.5" y="66.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="137" x="1091.5" y="86.9482">keeper.bankKeeper</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="151" x="1084.5" y="1862.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="137" x="1091.5" y="1882.5029">keeper.bankKeeper</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="121" x="1531.5" y="66.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1538.5" y="86.9482">vestingAccount</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="121" x="1531.5" y="1862.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="1538.5" y="1882.5029">vestingAccount</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="137" x="1666.5" y="66.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123" x="1673.5" y="86.9482">ctx.EventManager</text><rect fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="137" x="1666.5" y="1862.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123" x="1673.5" y="1882.5029">ctx.EventManager</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1817.5" y="98.9482">store</text><path d="M1820.5,49.9531 C1820.5,39.9531 1838.5,39.9531 1838.5,39.9531 C1838.5,39.9531 1856.5,39.9531 1856.5,49.9531 L1856.5,75.9531 C1856.5,85.9531 1838.5,85.9531 1838.5,85.9531 C1838.5,85.9531 1820.5,85.9531 1820.5,75.9531 L1820.5,49.9531 " fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" style="stroke:#000000;stroke-width:1.5;"/><path d="M1820.5,49.9531 C1820.5,59.9531 1838.5,59.9531 1838.5,59.9531 C1838.5,59.9531 1856.5,59.9531 1856.5,49.9531 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1817.5" y="1875.5029">store</text><path d="M1820.5,1888.8047 C1820.5,1878.8047 1838.5,1878.8047 1838.5,1878.8047 C1838.5,1878.8047 1856.5,1878.8047 1856.5,1888.8047 L1856.5,1914.8047 C1856.5,1924.8047 1838.5,1924.8047 1838.5,1924.8047 C1838.5,1924.8047 1820.5,1924.8047 1820.5,1914.8047 L1820.5,1888.8047 " fill="#FEFECE" filter="url(#f1hmxn5m89r15d)" style="stroke:#000000;stroke-width:1.5;"/><path d="M1820.5,1888.8047 C1820.5,1898.8047 1838.5,1898.8047 1838.5,1898.8047 C1838.5,1898.8047 1856.5,1898.8047 1856.5,1888.8047 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><polygon fill="#A80036" points="649,129.3828,659,133.3828,649,137.3828,653,133.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="118" x2="655" y1="133.3828" y2="133.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="519" x="125" y="128.3169">Delegate(Context, DelegatorAddress, Amount, Validator, tokenSrc := Unbonded)</text><path d="M30,148.3828 L94,148.3828 L94,155.3828 L84,165.3828 L30,165.3828 L30,148.3828 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="706.5" x="30" y="148.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="45" y="161.4497">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="325" x="109" y="160.5933">[exchange rate is invalid (tokens in validator is 0)]</text><polygon fill="#A80036" points="129,182.6484,119,186.6484,129,190.6484,125,186.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="123" x2="660" y1="186.6484" y2="186.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="135" y="181.5825">error</text><path d="M83,208.6484 L147,208.6484 L147,215.6484 L137,225.6484 L83,225.6484 L83,208.6484 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="158.3359" style="stroke:#000000;stroke-width:2.0;" width="842" x="83" y="208.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="98" y="221.7153">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="176" x="162" y="220.8589">[perform a new delegation]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="703" y1="246.9141" y2="246.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="703" x2="703" y1="246.9141" y2="259.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="662" x2="703" y1="259.9141" y2="259.9141"/><polygon fill="#A80036" points="672,255.9141,662,259.9141,672,263.9141,668,259.9141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="668" y="241.8481">delegation := create delegation object</text><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="703" y1="289.0469" y2="289.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="703" x2="703" y1="289.0469" y2="302.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="662" x2="703" y1="302.0469" y2="302.0469"/><polygon fill="#A80036" points="672,298.0469,662,302.0469,672,306.0469,668,302.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="668" y="283.981">BeforeDelegationCreated hook</text><path d="M93,274.4141 L93,299.4141 L652,299.4141 L652,284.4141 L642,274.4141 L93,274.4141 " fill="#FBFB77" filter="url(#f1hmxn5m89r15d)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M642,274.4141 L642,284.4141 L652,284.4141 L642,274.4141 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="538" x="99" y="291.481">Calls IncrementValidatorPeriod (Used to calculate distribution) in keeper/validator.go</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="83" x2="925" y1="311.0469" y2="311.0469"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="292" x="88" y="321.2573">[delegation exists, more tokens being added]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="703" y1="345.9844" y2="345.9844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="703" x2="703" y1="345.9844" y2="358.9844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="662" x2="703" y1="358.9844" y2="358.9844"/><polygon fill="#A80036" points="672,354.9844,662,358.9844,672,362.9844,668,358.9844" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="668" y="340.9185">BeforeDelegationModified hook</text><path d="M250,331.3516 L250,356.3516 L652,356.3516 L652,341.3516 L642,331.3516 L250,331.3516 " fill="#FBFB77" filter="url(#f1hmxn5m89r15d)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M642,331.3516 L642,341.3516 L652,341.3516 L642,331.3516 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="381" x="256" y="348.4185">withdraw current delegation rewards (and increment period)</text><path d="M565.5,380.9844 L629.5,380.9844 L629.5,387.9844 L619.5,397.9844 L565.5,397.9844 L565.5,380.9844 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="883.8672" style="stroke:#000000;stroke-width:2.0;" width="1334" x="565.5" y="380.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="580.5" y="394.0513">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="352" x="644.5" y="393.1948">[delegating from an account (subtractTokens == true)]</text><polygon fill="#A80036" points="1150,415.25,1160,419.25,1150,423.25,1154,419.25" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="1156" y1="419.25" y2="419.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="668" y="414.1841">DelegateCoinsFromAccountToModule</text><path d="M1044.5,434.25 L1429.5,434.25 L1429.5,441.25 L1419.5,451.25 L1044.5,451.25 L1044.5,434.25 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="454.5313" style="stroke:#000000;stroke-width:2.0;" width="845" x="1044.5" y="434.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="340" x="1059.5" y="447.3169">DelegateCoinsFromAccountToModule function</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1204" y1="472.5156" y2="472.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1204" x2="1204" y1="472.5156" y2="485.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1163" x2="1204" y1="485.5156" y2="485.5156"/><polygon fill="#A80036" points="1173,481.5156,1163,485.5156,1173,489.5156,1169,485.5156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1169" y="467.4497">DelegateCoinsFromAccountToModule</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1204" y1="514.6484" y2="514.6484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1204" x2="1204" y1="514.6484" y2="527.6484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1163" x2="1204" y1="527.6484" y2="527.6484"/><polygon fill="#A80036" points="1173,523.6484,1163,527.6484,1173,531.6484,1169,527.6484" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="1169" y="509.5825">DelegateCoins</text><path d="M1054.5,542.6484 L1271.5,542.6484 L1271.5,549.6484 L1261.5,559.6484 L1054.5,559.6484 L1054.5,542.6484 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="339.1328" style="stroke:#000000;stroke-width:2.0;" width="825" x="1054.5" y="542.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="172" x="1069.5" y="555.7153">DelegateCoins function</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1162" x2="1204" y1="580.9141" y2="580.9141"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1204" x2="1204" y1="580.9141" y2="593.9141"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1163" x2="1204" y1="593.9141" y2="593.9141"/><polygon fill="#A80036" points="1173,589.9141,1163,593.9141,1173,597.9141,1169,593.9141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="418" x="1169" y="575.8481">Check the delegator has enough balances of all tokens delegated</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1162" x2="1204" y1="623.0469" y2="623.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1204" x2="1204" y1="623.0469" y2="636.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1163" x2="1204" y1="636.0469" y2="636.0469"/><polygon fill="#A80036" points="1173,632.0469,1163,636.0469,1173,640.0469,1169,636.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="1169" y="617.981">Track delegation (register that it exists to keep track of it)</text><path d="M1074.5,651.0469 L1138.5,651.0469 L1138.5,658.0469 L1128.5,668.0469 L1074.5,668.0469 L1074.5,651.0469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="90.2031" style="stroke:#000000;stroke-width:2.0;" width="795" x="1074.5" y="651.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="1089.5" y="664.1138">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="195" x="1153.5" y="663.2573">[validator is currently bonded]</text><polygon fill="#A80036" points="1826.5,685.3125,1836.5,689.3125,1826.5,693.3125,1830.5,689.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1162" x2="1832.5" y1="689.3125" y2="689.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="1169" y="684.2466">Transfer tokens from delegator to BondedTokensPool.</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1074.5" x2="1869.5" y1="698.3125" y2="698.3125"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="300" x="1079.5" y="708.5229">[validator is currently unbonded or unbonding]</text><polygon fill="#A80036" points="1826.5,729.25,1836.5,733.25,1826.5,737.25,1830.5,733.25" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1162" x2="1832.5" y1="733.25" y2="733.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="1169" y="728.1841">Transfer tokens from delegator to NotBondedTokensPool.</text><path d="M1064.5,755.25 L1292.5,755.25 L1292.5,762.25 L1282.5,772.25 L1064.5,772.25 L1064.5,755.25 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="119.5313" style="stroke:#000000;stroke-width:2.0;" width="612" x="1064.5" y="755.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="183" x="1079.5" y="768.3169">trackDelegation function</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1204" y1="793.5156" y2="793.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1204" x2="1204" y1="793.5156" y2="806.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1163" x2="1204" y1="806.5156" y2="806.5156"/><polygon fill="#A80036" points="1173,802.5156,1163,806.5156,1173,810.5156,1169,806.5156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="1169" y="788.4497">trackDelegation</text><path d="M1074.5,821.5156 L1138.5,821.5156 L1138.5,828.5156 L1128.5,838.5156 L1074.5,838.5156 L1074.5,821.5156 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="592" x="1074.5" y="821.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="1089.5" y="834.5825">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="205" x="1153.5" y="833.7261">[delegator is a vesting account]</text><polygon fill="#A80036" points="1582,855.7813,1592,859.7813,1582,863.7813,1586,859.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1588" y1="859.7813" y2="859.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1169" y="854.7153">keep track of this delegation</text><polygon fill="#A80036" points="672,912.9141,662,916.9141,672,920.9141,668,916.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="666" x2="1161" y1="916.9141" y2="916.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="678" y="911.8481">nil (success)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="565.5" x2="1899.5" y1="925.9141" y2="925.9141"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="373" x="570.5" y="936.1245">[moving tokens between pools (subtractTokens == false)]</text><path d="M585.5,946.7188 L649.5,946.7188 L649.5,953.7188 L639.5,963.7188 L585.5,963.7188 L585.5,946.7188 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="90.2031" style="stroke:#000000;stroke-width:2.0;" width="664" x="585.5" y="946.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="600.5" y="959.7856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="374" x="664.5" y="958.9292">[delegator tokens are not bonded but validator is bonded]</text><polygon fill="#A80036" points="1150,980.9844,1160,984.9844,1150,988.9844,1154,984.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="1156" y1="984.9844" y2="984.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="439" x="668" y="979.9185">SendCoinsFromModuleToModule(notBondedPool, bondedPool, coins)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="585.5" x2="1249.5" y1="993.9844" y2="993.9844"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="374" x="590.5" y="1004.1948">[delegator tokens are bonded but validator is not bonded]</text><polygon fill="#A80036" points="1150,1024.9219,1160,1028.9219,1150,1032.9219,1154,1028.9219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="1156" y1="1028.9219" y2="1028.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="439" x="668" y="1023.856">SendCoinsFromModuleToModule(bondedPool, notBondedPool, coins)</text><path d="M575.5,1050.9219 L762.5,1050.9219 L762.5,1057.9219 L752.5,1067.9219 L575.5,1067.9219 L575.5,1050.9219 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="206.9297" style="stroke:#000000;stroke-width:2.0;" width="1294" x="575.5" y="1050.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="142" x="590.5" y="1063.9888">SendCoins function</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1204" y1="1089.1875" y2="1089.1875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1204" x2="1204" y1="1089.1875" y2="1102.1875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1163" x2="1204" y1="1102.1875" y2="1102.1875"/><polygon fill="#A80036" points="1173,1098.1875,1163,1102.1875,1173,1106.1875,1169,1102.1875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="1169" y="1084.1216">SendCoins</text><polygon fill="#A80036" points="1725,1127.3203,1735,1131.3203,1725,1135.3203,1729,1131.3203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1731" y1="1131.3203" y2="1131.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240" x="1169" y="1126.2544">Emit TransferEvent(to, from, amount)</text><path d="M585.5,1146.3203 L649.5,1146.3203 L649.5,1153.3203 L639.5,1163.3203 L585.5,1163.3203 L585.5,1146.3203 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="664" x="585.5" y="1146.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="600.5" y="1159.3872">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="356" x="664.5" y="1158.5308">[amount of spendable (balance - locked) coins too low]</text><polygon fill="#A80036" points="672,1180.5859,662,1184.5859,672,1188.5859,668,1184.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="666" x2="1161" y1="1184.5859" y2="1184.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="678" y="1179.52">error</text><polygon fill="#A80036" points="1826.5,1216.7188,1836.5,1220.7188,1826.5,1224.7188,1830.5,1220.7188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1832.5" y1="1220.7188" y2="1220.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="1169" y="1215.6528">subtract balance from sender</text><polygon fill="#A80036" points="1826.5,1245.8516,1836.5,1249.8516,1826.5,1253.8516,1830.5,1249.8516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1162" x2="1832.5" y1="1249.8516" y2="1249.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1169" y="1244.7856">add balance to recipient</text><polygon fill="#A80036" points="908,1288.9844,918,1292.9844,908,1296.9844,912,1292.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="914" y1="1292.9844" y2="1292.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="668" y="1287.9185">AddTokensFromDel</text><line style="stroke:#A80036;stroke-width:1.0;" x1="920" x2="962" y1="1335.75" y2="1335.75"/><line style="stroke:#A80036;stroke-width:1.0;" x1="962" x2="962" y1="1335.75" y2="1348.75"/><line style="stroke:#A80036;stroke-width:1.0;" x1="921" x2="962" y1="1348.75" y2="1348.75"/><polygon fill="#A80036" points="931,1344.75,921,1348.75,931,1352.75,927,1348.75" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="927" y="1330.6841">calculate number of shares to issue</text><path d="M278,1305.9844 L278,1360.9844 L911,1360.9844 L911,1315.9844 L901,1305.9844 L278,1305.9844 " fill="#FBFB77" filter="url(#f1hmxn5m89r15d)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M901,1305.9844 L901,1315.9844 L911,1315.9844 L901,1305.9844 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="454" x="284" y="1323.0513">If there are no shares (validator being created) then 1 token = 1 share.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="284" y="1338.1841">If there are already shares, then</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="612" x="284" y="1353.3169">added shares =  (added tokens amount) * (current validator shares) / (current validator tokens)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="920" x2="962" y1="1391.5156" y2="1391.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="962" x2="962" y1="1391.5156" y2="1404.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="921" x2="962" y1="1404.5156" y2="1404.5156"/><polygon fill="#A80036" points="931,1400.5156,921,1404.5156,931,1408.5156,927,1404.5156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="927" y="1386.4497">add delegated tokens to validator</text><polygon fill="#A80036" points="672,1429.6484,662,1433.6484,672,1437.6484,668,1433.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="666" x2="919" y1="1433.6484" y2="1433.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="678" y="1428.5825">validator, addedShares</text><polygon fill="#A80036" points="1826.5,1458.7813,1836.5,1462.7813,1826.5,1466.7813,1830.5,1462.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="1832.5" y1="1462.7813" y2="1462.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="668" y="1457.7153">update validator state</text><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="703" y1="1491.9141" y2="1491.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="703" x2="703" y1="1491.9141" y2="1504.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="662" x2="703" y1="1504.9141" y2="1504.9141"/><polygon fill="#A80036" points="672,1500.9141,662,1504.9141,672,1508.9141,668,1504.9141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="668" y="1486.8481">calculate new validator's power</text><path d="M39,1477.2813 L39,1502.2813 L652,1502.2813 L652,1487.2813 L642,1477.2813 L39,1477.2813 " fill="#FBFB77" filter="url(#f1hmxn5m89r15d)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M642,1477.2813 L642,1487.2813 L652,1487.2813 L642,1477.2813 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="592" x="45" y="1494.3481">Number of tokens divided by PowerReduction (default: 1,000,000,000,000,000,000 = 10^18)</text><path d="M230,1519.9141 L294,1519.9141 L294,1526.9141 L284,1536.9141 L230,1536.9141 L230,1519.9141 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="71.3984" style="stroke:#000000;stroke-width:2.0;" width="1639.5" x="230" y="1519.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="245" y="1532.981">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="147" x="309" y="1532.1245">[validator is not jailed]</text><polygon fill="#A80036" points="1826.5,1566.7461,1836.5,1570.7461,1826.5,1574.7461,1830.5,1570.7461" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="1832.5" y1="1570.7461" y2="1570.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="668" y="1565.6802">update validator's power in power index</text><path d="M240,1542.0469 L240,1582.0469 L652,1582.0469 L652,1552.0469 L642,1542.0469 L240,1542.0469 " fill="#FBFB77" filter="url(#f1hmxn5m89r15d)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M642,1542.0469 L642,1552.0469 L652,1552.0469 L642,1542.0469 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="246" y="1559.1138">the power index has entries shaped as 35 || power || address.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="349" x="246" y="1574.2466">This makes the validators sorted by power, high to low.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="661" x2="703" y1="1648.2109" y2="1648.2109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="703" x2="703" y1="1648.2109" y2="1661.2109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="662" x2="703" y1="1661.2109" y2="1661.2109"/><polygon fill="#A80036" points="672,1657.2109,662,1661.2109,672,1665.2109,668,1661.2109" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="668" y="1643.145">AfterDelegationModified hook</text><path d="M5,1603.3125 L5,1688.3125 L652,1688.3125 L652,1613.3125 L642,1603.3125 L5,1603.3125 " fill="#FBFB77" filter="url(#f1hmxn5m89r15d)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M642,1603.3125 L642,1613.3125 L652,1613.3125 L642,1603.3125 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="11" y="1620.3794">Calls initializeDelegation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="11" y="1635.5122">Store the previous period</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="11" y="1650.645">Calculate the number of tokens from shares</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="626" x="11" y="1665.7778">(shares the delegator has) * (tokens in delegation object)/(total tokens delegated to the validator)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="11" y="1680.9106">Store delegation starting info.</text><polygon fill="#A80036" points="129,1715.1094,119,1719.1094,129,1723.1094,125,1719.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="123" x2="660" y1="1719.1094" y2="1719.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="135" y="1714.0435">newShares (ignored by Delegate function)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="118" x2="160" y1="1748.2422" y2="1748.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="160" x2="160" y1="1748.2422" y2="1761.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="119" x2="160" y1="1761.2422" y2="1761.2422"/><polygon fill="#A80036" points="129,1757.2422,119,1761.2422,129,1765.2422,125,1761.2422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="125" y="1743.1763">Emit event: Delegation(ValidatorAddress)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="118" x2="160" y1="1790.375" y2="1790.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="160" x2="160" y1="1790.375" y2="1803.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="119" x2="160" y1="1803.375" y2="1803.375"/><polygon fill="#A80036" points="129,1799.375,119,1803.375,129,1807.375,125,1803.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="259" x="125" y="1785.3091">Emit event: Message(DelegatorAddress)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="118" x2="160" y1="1832.5078" y2="1832.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="160" x2="160" y1="1832.5078" y2="1845.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="119" x2="160" y1="1845.5078" y2="1845.5078"/><polygon fill="#A80036" points="129,1841.5078,119,1845.5078,129,1849.5078,125,1845.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="125" y="1827.4419">telemetry(Amount, Denom)</text><!--MD5=[fd0c8fc5c1816ae8b476d8b895a180d4]
@startuml
'https://plantuml.com/sequence-diagram

title: Delegating (currently undelegated funds delegator)

participant "msgServer (staking)"
participant  "keeper (staking)" as keeper
participant validator
participant keeper.bankKeeper
participant vestingAccount
participant ctx.EventManager

database store

"msgServer (staking)" -> keeper : Delegate(Context, DelegatorAddress, Amount, Validator, tokenSrc := Unbonded)

alt exchange rate is invalid (tokens in validator is 0)
    keeper - ->  "msgServer (staking)" : error
end

alt perform a new delegation
    keeper -> keeper : delegation := create delegation object
    keeper -> keeper : BeforeDelegationCreated hook
    note left: Calls IncrementValidatorPeriod (Used to calculate distribution) in keeper/validator.go
else delegation exists, more tokens being added
    keeper -> keeper : BeforeDelegationModified hook
    note left: withdraw current delegation rewards (and increment period)
end

alt delegating from an account (subtractTokens == true)
    keeper -> keeper.bankKeeper : DelegateCoinsFromAccountToModule
    group DelegateCoinsFromAccountToModule function
        keeper.bankKeeper -> keeper.bankKeeper : DelegateCoinsFromAccountToModule
        keeper.bankKeeper -> keeper.bankKeeper : DelegateCoins
        group DelegateCoins function
            keeper.bankKeeper - -> keeper.bankKeeper : Check the delegator has enough balances of all tokens delegated
            keeper.bankKeeper - -> keeper.bankKeeper : Track delegation (register that it exists to keep track of it)
            alt validator is currently bonded
                keeper.bankKeeper - -> store : Transfer tokens from delegator to BondedTokensPool.
            else validator is currently unbonded or unbonding
                keeper.bankKeeper - -> store : Transfer tokens from delegator to NotBondedTokensPool.
            end
            group trackDelegation function
                keeper.bankKeeper -> keeper.bankKeeper : trackDelegation
                alt delegator is a vesting account
                    keeper.bankKeeper -> vestingAccount : keep track of this delegation
                end
            end
        end
    end
    keeper <- - keeper.bankKeeper : nil (success)
else moving tokens between pools (subtractTokens == false)
    alt delegator tokens are not bonded but validator is bonded
       keeper -> keeper.bankKeeper : SendCoinsFromModuleToModule(notBondedPool, bondedPool, coins)
    else delegator tokens are bonded but validator is not bonded
       keeper -> keeper.bankKeeper : SendCoinsFromModuleToModule(bondedPool, notBondedPool, coins)
    end
    group SendCoins function
        keeper.bankKeeper -> keeper.bankKeeper : SendCoins
        keeper.bankKeeper -> ctx.EventManager : Emit TransferEvent(to, from, amount)
        alt amount of spendable (balance - locked) coins too low
            keeper <- - keeper.bankKeeper : error
        end
        keeper.bankKeeper -> store : subtract balance from sender
        keeper.bankKeeper -> store : add balance to recipient
    end
end

keeper -> validator : AddTokensFromDel
validator -> validator : calculate number of shares to issue
note left: If there are no shares (validator being created) then 1 token = 1 share.\nIf there are already shares, then\nadded shares =  (added tokens amount) * (current validator shares) / (current validator tokens)

validator -> validator : add delegated tokens to validator
keeper <- - validator : validator, addedShares
keeper -> store : update validator state
keeper -> keeper: calculate new validator's power
note left : Number of tokens divided by PowerReduction (default: 1,000,000,000,000,000,000 = 10^18)
alt validator is not jailed
    keeper -> store : update validator's power in power index
    note left : the power index has entries shaped as 35 || power || address.\nThis makes the validators sorted by power, high to low.
end

keeper -> keeper : AfterDelegationModified hook
note left: Calls initializeDelegation\nStore the previous period\nCalculate the number of tokens from shares\n(shares the delegator has) * (tokens in delegation object)/(total tokens delegated to the validator)\nStore delegation starting info.
"msgServer (staking)" <- - keeper : newShares (ignored by Delegate function)


"msgServer (staking)" -> "msgServer (staking)" : Emit event: Delegation(ValidatorAddress)
"msgServer (staking)" -> "msgServer (staking)" : Emit event: Message(DelegatorAddress)
"msgServer (staking)" -> "msgServer (staking)" : telemetry(Amount, Denom)

@enduml

@startuml

title: Delegating (currently undelegated funds delegator)

participant "msgServer (staking)"
participant  "keeper (staking)" as keeper
participant validator
participant keeper.bankKeeper
participant vestingAccount
participant ctx.EventManager

database store

"msgServer (staking)" -> keeper : Delegate(Context, DelegatorAddress, Amount, Validator, tokenSrc := Unbonded)

alt exchange rate is invalid (tokens in validator is 0)
    keeper - ->  "msgServer (staking)" : error
end

alt perform a new delegation
    keeper -> keeper : delegation := create delegation object
    keeper -> keeper : BeforeDelegationCreated hook
    note left: Calls IncrementValidatorPeriod (Used to calculate distribution) in keeper/validator.go
else delegation exists, more tokens being added
    keeper -> keeper : BeforeDelegationModified hook
    note left: withdraw current delegation rewards (and increment period)
end

alt delegating from an account (subtractTokens == true)
    keeper -> keeper.bankKeeper : DelegateCoinsFromAccountToModule
    group DelegateCoinsFromAccountToModule function
        keeper.bankKeeper -> keeper.bankKeeper : DelegateCoinsFromAccountToModule
        keeper.bankKeeper -> keeper.bankKeeper : DelegateCoins
        group DelegateCoins function
            keeper.bankKeeper - -> keeper.bankKeeper : Check the delegator has enough balances of all tokens delegated
            keeper.bankKeeper - -> keeper.bankKeeper : Track delegation (register that it exists to keep track of it)
            alt validator is currently bonded
                keeper.bankKeeper - -> store : Transfer tokens from delegator to BondedTokensPool.
            else validator is currently unbonded or unbonding
                keeper.bankKeeper - -> store : Transfer tokens from delegator to NotBondedTokensPool.
            end
            group trackDelegation function
                keeper.bankKeeper -> keeper.bankKeeper : trackDelegation
                alt delegator is a vesting account
                    keeper.bankKeeper -> vestingAccount : keep track of this delegation
                end
            end
        end
    end
    keeper <- - keeper.bankKeeper : nil (success)
else moving tokens between pools (subtractTokens == false)
    alt delegator tokens are not bonded but validator is bonded
       keeper -> keeper.bankKeeper : SendCoinsFromModuleToModule(notBondedPool, bondedPool, coins)
    else delegator tokens are bonded but validator is not bonded
       keeper -> keeper.bankKeeper : SendCoinsFromModuleToModule(bondedPool, notBondedPool, coins)
    end
    group SendCoins function
        keeper.bankKeeper -> keeper.bankKeeper : SendCoins
        keeper.bankKeeper -> ctx.EventManager : Emit TransferEvent(to, from, amount)
        alt amount of spendable (balance - locked) coins too low
            keeper <- - keeper.bankKeeper : error
        end
        keeper.bankKeeper -> store : subtract balance from sender
        keeper.bankKeeper -> store : add balance to recipient
    end
end

keeper -> validator : AddTokensFromDel
validator -> validator : calculate number of shares to issue
note left: If there are no shares (validator being created) then 1 token = 1 share.\nIf there are already shares, then\nadded shares =  (added tokens amount) * (current validator shares) / (current validator tokens)

validator -> validator : add delegated tokens to validator
keeper <- - validator : validator, addedShares
keeper -> store : update validator state
keeper -> keeper: calculate new validator's power
note left : Number of tokens divided by PowerReduction (default: 1,000,000,000,000,000,000 = 10^18)
alt validator is not jailed
    keeper -> store : update validator's power in power index
    note left : the power index has entries shaped as 35 || power || address.\nThis makes the validators sorted by power, high to low.
end

keeper -> keeper : AfterDelegationModified hook
note left: Calls initializeDelegation\nStore the previous period\nCalculate the number of tokens from shares\n(shares the delegator has) * (tokens in delegation object)/(total tokens delegated to the validator)\nStore delegation starting info.
"msgServer (staking)" <- - keeper : newShares (ignored by Delegate function)


"msgServer (staking)" -> "msgServer (staking)" : Emit event: Delegation(ValidatorAddress)
"msgServer (staking)" -> "msgServer (staking)" : Emit event: Message(DelegatorAddress)
"msgServer (staking)" -> "msgServer (staking)" : telemetry(Amount, Denom)

@enduml

PlantUML version 1.2021.4(Sun Apr 04 10:49:39 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>