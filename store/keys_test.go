package store

import (
	"math"
	"testing"

	"github.com/stretchr/testify/require"

	sdk "github.com/cosmos/cosmos-sdk/types"
)

func TestPrefixKey(t *testing.T) {
	out1 := PrefixKeyString("fooprefix")
	require.Equal(t, "fooprefix", string(out1))
	out2 := PrefixKeyString("fooprefix", []byte("sub1"), []byte("sub2"))
	require.Equal(t, "fooprefix/sub1/sub2", string(out2))
}

func TestUint64AndInt64Subkey(t *testing.T) {
	tests := []struct {
		in  int64
		out []byte
	}{
		{
			0,
			[]byte{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},
		{
			1000,
			[]byte{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe8},
		},
		{
			math.MaxInt64,
			[]byte{0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
		},
	}

	for _, tt := range tests {
		require.Equal(t, tt.out, Int64Subkey(tt.in))
		require.Equal(t, tt.out, Uint64Subkey(uint64(tt.in)))
	}

	require.Equal(t, []byte{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff}, Uint64Subkey(math.MaxUint64))
}

func TestInt64Subkey_Panics(t *testing.T) {
	require.Panics(t, func() {
		Int64Subkey(-1)
	})
	require.Panics(t, func() {
		Int64Subkey(-10)
	})
}

func TestSDKUintSubkey(t *testing.T) {
	tests := []struct {
		in        sdk.Uint
		out       []byte
		padToBits int
	}{
		{
			sdk.ZeroUint(),
			[]byte{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			256,
		},
		{
			sdk.OneUint(),
			[]byte{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1},
			256,
		},
		{
			sdk.NewUint(1234567890),
			[]byte{0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x49, 0x96, 0x2, 0xd2},
			256,
		},
		{
			sdk.NewUint(255),
			[]byte{0x00, 0x00, 0x00, 0xff},
			32,
		},
	}

	for _, tt := range tests {
		require.Equal(t, tt.out, SDKUintSubkey(tt.in, tt.padToBits))
	}

	require.Panics(t, func() {
		SDKUintSubkey(sdk.NewUint(math.MaxUint16), 8)
	})
	require.Panics(t, func() {
		SDKUintSubkey(sdk.NewUint(100), 7)
	})
}
